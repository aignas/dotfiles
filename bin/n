#!/bin/bash
set -euo pipefail

die() {
    echo >&2 ERROR: $@
    echo >&2 Exiting...
    exit 1
}

commit() {
    local -r dir="$1"
    shift

    msg="$*"
    if [ $# -eq 0 ]; then
        msg=${1:-snapshot}
    fi

    if git -C "$dir" diff --exit-code >/dev/null; then
        echo "no changes: $(basename $dir)"
        return 1
    else
        echo "commiting changes: $(basename $dir)"
    fi

    git -C "$dir" add -A .
    git -C "$dir" commit -am "${msg}"
    git -C "$dir" pull origin main --rebase || :
    git -C "$dir" push -u origin main || :
}

notes_dir() {
    dir="$HOME/.$1/zettel"
    [[ -d $dir ]] || die directory "$dir" does not exist
    echo $dir
}

neuron() {
    dir="$(notes_dir notes)"
    if [[ "$#" != 0 && "$1" == --work ]]; then
        dir="$(notes_dir "work")"
        shift
    fi

    args=($@)
    if [[ "$#" == 0 ]]; then
        args=(
            -o /tmp
            gen
            --watch
            --pretty-urls
            --serve 0.0.0.0:8080
        )
    fi

    exec docker run \
        --rm \
        --tty \
        --interactive \
        --publish 8080:8080 \
        --volume "$dir":/notes \
        sridca/neuron:1.9.27.3 \
        neuron "${args[@]}"
}

rename() {
    [[ "${1:-}" != "" ]] || die "No arguments supplied"

    case ${2:-} in
        '')
            rg "$1" -w
            exit 0
            ;;
        *)
            if [[ "$#" != 2 ]]; then
                echo no spaces in the name plz
                exit 1
            fi

            rg "$1" -l zettel | xargs sed -i "s/($1)/($2)/g"
            mv "zettel/$1.md" "zettel/$2.md"
            git add -A zettel
            git commit -m "Rename: $1 -> $2"
            ls -l zettel | head
            ;;
    esac
}

main() {
    command="$1"; shift

    case "$command" in
        serve|neuron)   neuron "$@" ;;
        commit)         commit ~/.notes "$@" || commit ~/.work "$@" ;;
        rename)         rename "$@" ;;
        *)              die unknown command "$command" ;;
    esac
}

main "$@"
