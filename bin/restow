#!/bin/bash
set -euo pipefail

cd "${HOME}/.dotfiles"

_stow() {
    stow --verbose --ignore=install.sh "$@"
    #stow "$@" 2>/dev/null
}

if [[ "$(stow --version)" =~ "2.2.2" ]]; then
    echo "stow: legacy"
    pushd legacy
    ./refresh.sh
    popd

    _stow \
        --target="${HOME}" \
        --restow legacy \
        "$@"
else
    _stow --dotfiles --restow stow "$@"

    echo "stow: dotfiles"
    _stow --dotfiles \
        --target="${HOME}" \
        --restow git \
        --restow task \
        --restow tmux \
        --restow zsh \
        "$@"
fi

echo "stow: bin"
mkdir -p "${HOME}/bin"
_stow \
    --target="${HOME}/bin" \
    --restow bin \
    "$@"

echo "stow: XDG config"
mkdir -p "${HOME}/.config"
_stow \
    --target="${XDG_CONFIG_HOME:-${HOME}/.config}" \
    --restow alacritty \
    --restow lf \
    --restow neovim \
    --restow pacman \
    --restow qutebrowser \
    --restow spotify \
    --restow sway \
    --restow yabai \
    --restow xdg \
    "$@"

echo "stow: aerc config"
mkdir -p "${HOME}/.config/aerc"
_stow \
    --target="${XDG_CONFIG_HOME:-${HOME}/.config}/aerc" \
    --restow aerc \
    "$@"

echo "stow: taskwarrior hooks"
mkdir -p "${HOME}/.task/hooks"
_stow \
    --target="${HOME}/.task/hooks" \
    --dir task/ \
    --restow taskhooks \
    "$@"
