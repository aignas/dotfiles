#!/bin/bash
set -euo pipefail

cd "${HOME}/.dotfiles"

_stow() {
    stow --verbose --ignore=install.sh "$@"
    #stow "$@" 2>/dev/null
}

_stow_dir() {
    local -r dir=$1
    shift

    echo "stow: $dir"
    mkdir -p "$dir"
    _stow --target="$dir" "$@"
}

if [[ "$(stow --version)" =~ "2.2.2" ]]; then
    echo "stow: legacy"
    pushd legacy
    ./refresh.sh
    popd

    _stow \
        --target="${HOME}" \
        --restow legacy \
        "$@"
else
    _stow --dotfiles --restow stow "$@"

    _stow_dir \
        "${HOME}" \
        --restow git \
        --restow task \
        --restow tmux \
        --restow zsh \
        --dotfiles \
        "$@"
fi

_stow_dir "${HOME}/.local/bin" \
    --restow bin \
    --restow tools \
    "$@"

pushd golang/goenv
_stow_dir "${HOME}/.local/bin" \
    --restow bin \
    "$@"
popd

xdg_stow=(
    --restow alacritty
    --restow lf
    --restow neovim
    --restow qutebrowser
    --restow spotify
)

if [[ $(uname -s) == "Linux" ]]; then
    xdg_stow+=(
        --restow newsboat
        --restow pacman
        --restow sway
        --restow xdg
    )
fi

_stow_dir "${XDG_CONFIG_HOME:-${HOME}/.config}" "${xdg_stow[@]}" "$@"
_stow_dir "${XDG_CONFIG_HOME:-${HOME}/.config}/aerc" --restow aerc "$@"

_stow_dir \
    "${HOME}/.task/hooks" \
    --dir task/ \
    --restow taskhooks \
    "$@"
