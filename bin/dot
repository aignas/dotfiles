#!/usr/bin/env bash

[[ -z "${DOTFILES_ROOT}" ]] && DOTFILES_ROOT="$(cd "$(dirname "$0")/.." && pwd)"
export DOTFILES_ROOT

print_help(){
  cat <<EOF
dot -- dotfiles management

Usage: dot [options]

Default is to update the dotfiles and setup the system for work.

Options:
 -e, --edit   Open dotfiles directory for editing
 -l, --lint   Lint dotfiles
 -h, --help   Show this help message and exti
EOF
}

while test $# -gt 0; do
  case "$1" in
    "-h"|"--help") print_help;;
    "-e"|"--edit") exec e "${DOTFILES_ROOT}";;
    "-l"|"--lint") exec "${DOTFILES_ROOT}/script/lint";;
    *) echo "Invalid option: $1"; print_help; exit 1;;
  esac
  exit 0
  shift
done

# Update
if [[ -n "$(git -C "${DOTFILES_ROOT}" diff)" ]]
then
  echo "Commit the changes and try again."
  exit 1
fi

git -C "${DOTFILES_ROOT}" pull --rebase
git -C "${DOTFILES_ROOT}" submodule update --recursive
git -C "${DOTFILES_ROOT}" push
"${DOTFILES_ROOT}/script/bootstrap" --overwrite
